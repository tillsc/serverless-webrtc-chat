<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title> JOIN WebRTC channel </title>
  <link href="noserv.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="src/connector.js"></script>
</head>

<body>
  <h2> JOIN WebRTC channel <span id="status"> init </span> </h2>
  <h3> 2.GET Offer's SDP</h3>
  <textarea id="creater-sdp" placeholder="HERE COPY & PASTE [1.CREATE Offer's SDP]"></textarea>
  <h3> 3.CREATE Participant'S SDP <button id="create">CREATE</button> </h3>
  <textarea id="joiner-sdp"></textarea>
  <h3> CHAT </h3>
  <div id="chat">
    <div id="chat-screen-wp">
      <div id="chat-screen"></div>
    </div>
    <div id="ct"><input id="msg" disabled><button id="send" disabled>send</button></div>
  </div>
  <rtc-connector debug></rtc-connector>
  <div id="qrcode"></div>
  <script>
    const connector = document.querySelector('rtc-connector');

    connector.addEventListener("opened", () => {
      $("textarea").attr("disabled", true);
      $("#msg, #send").attr("disabled", false);
      addMSG("CONNECTED!", "info")
    });

    connector.addEventListener("message", (e) => addMSG(e.detail.message, "other"));

    let qrcode = new QRCode(document.getElementById("qrcode"));

    connector.addEventListener("localdescriptionchange", (e) => {
      let s = JSON.stringify({answerDesc: e.detail.localDescription});
      $("#joiner-sdp").val(s);
      qrcode.clear();
      qrcode.makeCode(s);
    });

    connector.addEventListener("iceconnectionstatechange", (e) => {
      $('#status').html(e.detail.state);
    });

    function createAnswerSDP() {
      const data = JSON.parse($("#creater-sdp").val());
      if (data.offerDesc) {
        connector.acceptOfferAndCreateAnswer(data.offerDesc);
      }
      else {
        alert("Expected JSON to include 'offerDesc' property")
      }
    }

    function sendMSG() {
      var value = $("#msg").val();
      if (value) {
        connector.send(value);
        addMSG(value, "me");
        $("#msg").val('');
      }
    }

    function addMSG(msg, who) {
      var wrap = $("<div>").addClass("wrap").appendTo($("#chat-screen"));
      var div = $("<div>").addClass(who).appendTo(wrap);
      $("<span>").html(who).addClass("who").appendTo(div);
      $("<span>").html(msg).addClass("msg").appendTo(div);
      $("#chat-screen-wp").scrollTop($("#chat-screen").height());
    }

    $("#create").click(createAnswerSDP);
    $("#msg").keypress(function (e) { if (e.which == 13) { sendMSG() } });
    $("#send").click(sendMSG);
  </script>
</body>

</html>