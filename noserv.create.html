<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title> CREATE WebRTC channel </title>
  <link href="noserv.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="src/connector.js"></script>
</head>

<body>
  <h2> CREATE WebRTC channel <span id="status"> init </span></h2>
  <h3> 1.CREATE Offer's SDP </h3>
  <textarea id="creater-sdp"></textarea>
  <h3> 4.GET Participant's SDP <button id="accept-answer">Accept answer</button></h3>
  <textarea id="joiner-sdp" placeholder="HERE COPY AND PASTE [3.Participant'S SDP]"></textarea>
  <h3> CHAT </h3>
  <div id="chat">
    <div id="chat-screen-wp">
      <div id="chat-screen"></div>
    </div>
    <div id="ct"><input id="msg" disabled><button id="send" disabled>send</button></div>
  </div>
  <rtc-connector debug></rtc-connector>
  <script>
    const connector = document.querySelector('rtc-connector');

    connector.addEventListener("opened", () => {
      $("textarea").attr("disabled", true);
      $("#msg, #send").attr("disabled", false);
      addMSG("CONNECTED!", "info")
    });

    connector.addEventListener("message", (e) => addMSG(e.detail.message, "other"));

    connector.addEventListener("localdescriptionchange", (e) => {
      $("#creater-sdp").val(JSON.stringify({ offerDesc: e.detail.localDescription }));
    });

    connector.addEventListener("iceconnectionstatechange", (e) => {
      $('#status').html(e.detail.state);
    });

    connector.startOffering();

    function acceptAnswer() {
      const data = JSON.parse($("#joiner-sdp").val());
      if (data.answerDesc) {
        connector.acceptAnswer(data.answerDesc);
      }
      else {
        alert("Expected JSON to include 'answerDesc' property")
      }
    }

    var addMSG = function (msg, who) {
      var wrap = $("<div>").addClass("wrap").appendTo($("#chat-screen"));
      var div = $("<div>").addClass(who).appendTo(wrap);
      $("<span>").html(who).addClass("who").appendTo(div);
      $("<span>").html(msg).addClass("msg").appendTo(div);
      $("#chat-screen-wp").scrollTop($("#chat-screen").height());
    }

    var sendMSG = function () {
      var value = $("#msg").val();
      if (value) {
        connector.send(value);
        addMSG(value, "me");
        $("#msg").val('');
      }
    }
    $("#accept-answer").click(function () { acceptAnswer(); });
    $("#msg").keypress(function (e) { if (e.which == 13) { sendMSG() } });
    $("#send").click(sendMSG);
  </script>
</body>

</html>